<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code 投票單產生器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- General UI Styles --- */
        .section-header {
            border-bottom: 2px solid #ef4444; /* red-500 */
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: #b91c1c; /* red-700 */
        }
        .option-input-group {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 0.5rem;
            align-items: center;
        }
        .tab-button {
            padding: 0.5rem 1.5rem;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        .tab-button.active {
            color: #b91c1c; /* red-700 */
            border-bottom-color: #ef4444; /* red-500 */
        }
        
        #reader {
            border: 2px dashed #cbd5e1;
            border-radius: 0.5rem;
            overflow: hidden;
        }

        /* --- Hide/Show Logic for Printing --- */
        body.printing #app, body.printing #loader, body.printing #custom-modal {
            visibility: hidden;
        }
        body:not(.printing) #print-area {
            display: none;
        }

        /* --- Custom Modal Styles --- */
        #custom-modal {
            transition: opacity 0.3s ease-in-out;
        }
        #custom-modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
        #modal-content {
            transition: transform 0.3s ease-in-out;
            transform: scale(0.95);
        }
        #custom-modal:not(.hidden) #modal-content {
            transform: scale(1);
        }

        /* --- Print Specific Styles --- */
        @media print {
            @page {
                size: A4;
                margin: 1cm;
            }

            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            #app, #loader, #custom-modal {
                display: none !important;
            }

            #print-area {
                display: block !important;
            }

            .resident-print-container {
                page-break-before: always;
                counter-reset: page;
                /* position: relative; /* No longer needed here */
            }
            .resident-print-container:first-child {
                page-break-before: auto;
            }
            
            .poll-container {
                page-break-inside: avoid;
                margin-top: 1.5rem;
                border: 1px solid #666;
                padding: 0.75rem;
                border-radius: 5px;
            }
            
            .print-header {
                text-align: center;
                margin-bottom: 1rem;
            }
            
            .print-header h1 { font-size: 18pt; font-weight: bold; margin: 0; }
            .print-header h2 { font-size: 16pt; font-weight: bold; margin: 0; }
            .print-header p { text-align: right; margin: 0.5rem 0 0 0; }

            .resident-unit-header {
                position: absolute;
                top: 0;
                right: 0;
                font-size: 14pt;
                font-weight: bold;
            }
            
            .poll-title {
                font-size: 14pt;
                font-weight: bold;
                margin-bottom: 0.75rem;
            }
            
            .poll-details {
                text-align: left;
                font-size: 11pt;
                margin-bottom: 1rem;
                line-height: 1.6;
            }

            .options-grid {
                display: flex;
                flex-wrap: wrap;
                gap: 1rem;
                justify-content: flex-start;
            }

            .option-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                text-align: center;
                page-break-inside: avoid;
                flex: 0 0 calc(20% - 0.8rem); /* 5 items per row, accounting for gap */
                max-width: calc(20% - 0.8rem);
            }
            
            .print-table {
                width: 100%;
                border-collapse: collapse;
            }
            .print-table thead {
                display: table-header-group;
            }
            .print-table tfoot {
                display: table-footer-group;
            }
            .print-footer {
                text-align: center;
                padding-top: 1em;
                font-size: 10pt;
                color: #666;
            }
            .print-footer::after {
                counter-increment: page;
                content: "第 " counter(page) " 頁";
            }
            .print-header-wrapper {
                position: relative;
                padding-bottom: 1rem; /* Space between header and content */
            }

            .option-qr-code {
                width: 80px;
                height: 80px;
                margin-bottom: 0.5rem;
            }
            .option-qr-code img, .option-qr-code canvas {
                width: 100% !important;
                height: 100% !important;
            }

            .option-text {
                font-size: 12pt;
                word-break: break-word;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="max-w-7xl mx-auto p-4 md:p-8 space-y-8">

        <!-- Tabs -->
        <div class="bg-white rounded-lg shadow-md p-2">
            <nav id="tabs" class="flex items-center justify-center flex-wrap">
                <button data-tab="settings-panel" class="tab-button active">投票單設定</button>
                <button data-tab="scanner-voting-panel" class="tab-button">掃碼投票</button>
                <button data-tab="status-panel" class="tab-button">即時投票狀況</button>
            </nav>
        </div>

        <!-- Panels -->
        <div id="settings-panel">
            <!-- 1. Settings Section -->
            <section class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="section-header">基本設定</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="community-name" class="block text-sm font-medium text-gray-700">社區名稱</label>
                        <input type="text" id="community-name" value="西北社區" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                    </div>
                    <div>
                        <label for="event-name" class="block text-sm font-medium text-gray-700">會議活動名稱</label>
                        <input type="text" id="event-name" value="113年度區分所有權人會議" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                    </div>
                    <div>
                        <label for="event-date" class="block text-sm font-medium text-gray-700">投票日期</label>
                        <input type="date" id="event-date" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                    </div>
                </div>
            </section>

            <!-- 2. Polls Management Section -->
            <section class="bg-white p-6 rounded-lg shadow-md mb-8">
                <div class="flex justify-between items-center">
                    <h2 class="section-header">投票議題管理</h2>
                    <button id="add-poll-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">新增投票</button>
                </div>
                <div id="polls-list" class="mt-4 space-y-4">
                    <!-- Polls will be dynamically inserted here -->
                </div>
            </section>
            
            <!-- 3. Residents List Section -->
            <section class="bg-white p-6 rounded-lg shadow-md mb-8">
                 <div class="flex flex-wrap justify-between items-center gap-4">
                     <h2 class="section-header">住戶列表</h2>
                     <div class="flex items-center gap-2">
                         <input type="file" id="import-csv-input" class="hidden" accept=".csv,text/csv">
                         <button id="import-csv-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">從CSV匯入</button>
                         <button id="clear-residents-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-600 transition-colors">清空列表</button>
                     </div>
                 </div>
                 <p class="text-sm text-gray-600 mt-2">
                     請從「西北社區QR Code報到系統」的住戶管理頁面，點擊「匯出CSV」按鈕，然後將下載的檔案從這裡匯入。
                     <a href="#" id="download-sample-csv" class="text-blue-600 hover:underline">下載範例CSV檔</a>
                 </p>
                 <div class="mt-2 text-sm font-medium text-gray-700">
                    已選擇 <span id="selected-residents-count" class="font-bold text-red-600">0</span> / <span id="total-residents-count" class="font-bold">0</span> 位住戶
                </div>
                 <div class="mt-4 overflow-x-auto max-h-96">
                     <table class="min-w-full divide-y divide-gray-200">
                         <thead class="bg-gray-50 sticky top-0 z-10">
                             <tr>
                                 <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">
                                     <input type="checkbox" id="select-all-residents" class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                                 </th>
                                 <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">序號</th>
                                 <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">QR Code</th>
                                 <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">戶號</th>
                                 <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">姓名</th>
                                 <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">地址</th>
                                 <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">坪數</th>
                                 <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">區分權比例</th>
                                 <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">手動投票</th>
                             </tr>
                         </thead>
                         <tbody id="residents-list" class="bg-white divide-y divide-gray-200">
                             <!-- Residents will be dynamically inserted here -->
                         </tbody>
                     </table>
                 </div>
            </section>

            <!-- 4. Action Button -->
            <section class="text-center">
                <button id="generate-print-btn" class="bg-red-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-red-700 text-xl transition-transform transform hover:scale-105">
                    列印投票單
                </button>
            </section>
        </div>

        <div id="scanner-voting-panel" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-lg font-semibold mb-4">攝影機掃描</h3>
                    <div class="flex gap-4 mb-4">
                        <button id="start-vote-scan-btn" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-md hover:bg-green-600 disabled:bg-gray-400">開始掃碼</button>
                        <button id="stop-vote-scan-btn" class="w-full bg-red-500 text-white font-bold py-2 px-4 rounded-md hover:bg-red-600 disabled:bg-gray-400" disabled>停止掃碼</button>
                    </div>
                    <div id="vote-reader" class="w-full aspect-square bg-gray-100 flex items-center justify-center">
                        <p id="vote-reader-placeholder" class="text-gray-500">請點擊 "開始掃碼"</p>
                    </div>
                    <div id="scanner-vote-status" class="mt-4 text-center font-semibold p-3 rounded-md">&nbsp;</div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-lg font-semibold mb-4">掃碼槍/手動輸入</h3>
                    <form id="scan-gun-vote-form" class="mb-4">
                        <label for="scan-gun-vote-input" class="sr-only">QR Code</label>
                        <input type="text" id="scan-gun-vote-input" placeholder="將游標點擊此處後開始掃碼..." class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500">
                    </form>
                    <h4 class="font-semibold mb-2">最近投票紀錄：</h4>
                    <ul id="scanner-recent-votes-list" class="space-y-2 max-h-80 overflow-y-auto">
                        <li class="text-gray-500 text-center">掃碼紀錄將顯示於此</li>
                    </ul>
                </div>
            </div>
        </div>

        <div id="status-panel" class="hidden">
            <!-- Voting Status will be rendered here -->
        </div>

    </div>
    
    <!-- Loading Spinner -->
    <div id="loader" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 z-50 flex items-center justify-center">
        <div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-white"></div>
        <span class="ml-4 text-white text-xl">正在產生投票單...</span>
    </div>

    <!-- Custom Modal -->
    <div id="custom-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 z-50 flex items-center justify-center p-4">
        <div id="modal-content" class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:max-w-md mx-auto max-h-[90vh] overflow-y-auto">
            <h3 id="modal-title" class="text-lg font-bold text-gray-800"></h3>
            <div id="modal-body" class="mt-2 text-sm text-gray-600"></div>
            <div id="modal-buttons" class="mt-6 flex justify-end space-x-3">
                <!-- Buttons will be injected here -->
            </div>
        </div>
    </div>

    <!-- This div is used for printing and is not visible on screen -->
    <div id="print-area"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const communityNameInput = document.getElementById('community-name');
        const eventNameInput = document.getElementById('event-name');
        const eventDateInput = document.getElementById('event-date');
        const addPollBtn = document.getElementById('add-poll-btn');
        const pollsListContainer = document.getElementById('polls-list');
        const importCsvInput = document.getElementById('import-csv-input');
        const importCsvBtn = document.getElementById('import-csv-btn');
        const clearResidentsBtn = document.getElementById('clear-residents-btn');
        const residentsListTbody = document.getElementById('residents-list');
        const selectAllResidentsCheckbox = document.getElementById('select-all-residents');
        const generatePrintBtn = document.getElementById('generate-print-btn');
        const downloadSampleCsvBtn = document.getElementById('download-sample-csv');
        const selectedResidentsCountSpan = document.getElementById('selected-residents-count');
        const totalResidentsCountSpan = document.getElementById('total-residents-count');
        const loader = document.getElementById('loader');
        const tabsContainer = document.getElementById('tabs');
        const settingsPanel = document.getElementById('settings-panel');
        const statusPanel = document.getElementById('status-panel');
        const scannerVotingPanel = document.getElementById('scanner-voting-panel');
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalButtons = document.getElementById('modal-buttons');

        // --- Scanner Voting Elements ---
        const startVoteScanBtn = document.getElementById('start-vote-scan-btn');
        const stopVoteScanBtn = document.getElementById('stop-vote-scan-btn');
        const voteReaderPlaceholder = document.getElementById('vote-reader-placeholder');
        const scanGunVoteForm = document.getElementById('scan-gun-vote-form');
        const scanGunVoteInput = document.getElementById('scan-gun-vote-input');
        const scannerVoteStatus = document.getElementById('scanner-vote-status');
        const scannerRecentVotesList = document.getElementById('scanner-recent-votes-list');

        // --- Data State ---
        const STORAGE_KEY = 'qrVoteGeneratorState';
        let state = {
            settings: {
                communityName: '西北社區',
                eventName: '113年度區分所有權人會議',
                eventDate: new Date().toISOString().split('T')[0],
            },
            polls: [],
            residents: [],
            votes: {}, // { residentId: { pollId: qrValue } }
            pollIdCounter: 0,
        };
        let html5QrCode = null;

        // --- Modal Logic ---
        let modalResolve = null;

        const showModal = (title, content, buttons) => {
            modalTitle.textContent = title;
            modalBody.innerHTML = '';
            if (typeof content === 'string') {
                const p = document.createElement('p');
                p.innerHTML = content;
                modalBody.appendChild(p);
            } else {
                modalBody.appendChild(content);
            }
            modalButtons.innerHTML = '';
            buttons.forEach(btn => {
                const buttonEl = document.createElement('button');
                buttonEl.textContent = btn.text;
                buttonEl.className = btn.class;
                buttonEl.onclick = () => {
                    // Don't hide for submit, let the handler do it
                    if (btn.value !== 'submit') hideModal();
                    if (modalResolve) modalResolve(btn.value);
                };
                modalButtons.appendChild(buttonEl);
            });
            modal.classList.remove('hidden');
            return new Promise(resolve => {
                modalResolve = resolve;
            });
        };

        const hideModal = () => modal.classList.add('hidden');

        const showAlert = (title, message) => showModal(title, message, [
            { text: '確定', value: true, class: 'bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700' }
        ]);

        const showConfirm = (title, message) => showModal(title, message, [
            { text: '取消', value: false, class: 'bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-400' },
            { text: '確定', value: true, class: 'bg-red-600 text-white font-bold py-2 px-4 rounded-md hover:bg-red-700' }
        ]);
        
        // --- State Management ---
        const debounce = (func, delay) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        };

        const saveState = () => {
            state.settings.communityName = communityNameInput.value;
            state.settings.eventName = eventNameInput.value;
            state.settings.eventDate = eventDateInput.value;
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            } catch (error) {
                console.error("Could not save state to localStorage:", error);
            }
        };

        const debouncedSaveState = debounce(saveState, 500);

        const loadState = () => {
            try {
                const savedState = localStorage.getItem(STORAGE_KEY);
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    if (parsedState.settings && parsedState.polls && parsedState.residents) {
                        state = { ...state, ...parsedState };
                        if (!state.votes) state.votes = {}; // Ensure votes object exists
                    }
                }
            } catch (error) {
                console.error("Could not load state from localStorage:", error);
                localStorage.removeItem(STORAGE_KEY);
            }
            
            communityNameInput.value = state.settings.communityName;
            eventNameInput.value = state.settings.eventName;
            eventDateInput.value = state.settings.eventDate || new Date().toISOString().split('T')[0];

            if (state.polls.length === 0) addInitialPoll();
            else renderPolls();
            renderResidents();
        };

        // --- Utility Functions ---
        const escapeHTML = (str) => {
            if (typeof str !== 'string') return '';
            return str.replace(/[&<>"']/g, match => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[match]));
        };

        function speak(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-TW';
                speechSynthesis.speak(utterance);
            }
        }

        // --- Core Functions ---
        function addInitialPoll() {
            createPoll({
                sectionTitle: '議題 #1',
                title: '管理費調整案',
                proposer: '管理委員會',
                description: '為提升社區服務品質，擬調整管理費...',
                options: [ { text: '同意', qrValue: 'M01-01' }, { text: '不同意', qrValue: 'M01-02' }, { text: '廢票', qrValue: 'M01-03' } ]
            });
        }
        
        async function handleCsvImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                try {
                    const parsedResidents = parseCSV(text);
                    if (parsedResidents.length === 0) {
                        await showAlert('匯入失敗', 'CSV檔案中沒有可辨識的住戶資料...');
                        return;
                    }
                    state.residents = parsedResidents;
                    renderResidents();
                    debouncedSaveState();
                    await showAlert('匯入成功', `成功匯入 ${state.residents.length} 筆住戶資料！`);
                } catch (error) {
                    console.error("CSV Parsing Error:", error);
                    await showAlert('匯入失敗', `發生錯誤...`);
                }
            };
            reader.onerror = () => showAlert('錯誤', '讀取檔案時發生錯誤。');
            reader.readAsText(file, "UTF-8");
            event.target.value = '';
        }

        function parseCSV(text) {
            const rows = text.split('\n').filter(row => row.trim() !== '');
            if (rows.length < 2) throw new Error("CSV檔案至少需要一個標頭行和一行資料。");
            
            const headerRow = rows[0].trim().startsWith('\uFEFF') ? rows[0].trim().substring(1) : rows[0].trim();
            const headers = headerRow.split(',').map(h => h.replace(/"/g, '').trim());

            const headerMap = {
                qrcodeValue: ['qrcodeValue', 'QR Code', 'QR Code碼'], unit: ['unit', '戶號'], name: ['name', '姓名'],
                address: ['address', '住址', '地址'], area: ['area', '坪數'], ownership: ['ownership', '區分權(%)', '區分權比例']
            };
            const findIndex = (possibleNames) => {
                for (const name of possibleNames) {
                    const index = headers.indexOf(name);
                    if (index !== -1) return index;
                }
                return -1;
            };
            const indices = {
                qrcodeValue: findIndex(headerMap.qrcodeValue), unit: findIndex(headerMap.unit), name: findIndex(headerMap.name),
                address: findIndex(headerMap.address), area: findIndex(headerMap.area), ownership: findIndex(headerMap.ownership)
            };
            if (indices.unit === -1 || indices.name === -1) throw new Error(`CSV檔案的標頭 (header) 必須包含 "戶號" 和 "姓名"。`);
            
            const importedResidents = [];
            for (let i = 1; i < rows.length; i++) {
                const values = rows[i].trim().split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.replace(/"/g, '').trim());
                const resident = {
                    id: `resident-${i}`, unit: values[indices.unit] || '', name: values[indices.name] || '',
                    qrcodeValue: indices.qrcodeValue !== -1 ? (values[indices.qrcodeValue] || '') : '',
                    address: indices.address !== -1 ? (values[indices.address] || '') : '',
                    area: indices.area !== -1 ? (values[indices.area] || '') : '',
                    ownership: indices.ownership !== -1 ? (values[indices.ownership] || '') : ''
                };
                if (resident.unit && resident.name) importedResidents.push(resident);
            }
            return importedResidents;
        }

        async function clearResidentsList() {
            if (state.residents.length > 0) {
                if (await showConfirm('清空住戶列表', '您確定要清空目前的住戶列表嗎？此操作無法復原。')) {
                    state.residents = [];
                    state.votes = {};
                    renderResidents();
                    debouncedSaveState();
                }
            }
        }
        
        function createPoll(initialData = {}) {
            state.pollIdCounter++;
            const pollId = `poll-${state.pollIdCounter}`;
            const pollNumberStr = String(state.pollIdCounter).padStart(2, '0');
            const pollData = {
                id: pollId, sectionTitle: initialData.sectionTitle || `議題 #${state.pollIdCounter}`,
                title: initialData.title || `新投票 ${state.pollIdCounter}`, proposer: initialData.proposer || '',
                description: initialData.description || '',
                options: initialData.options || [ { text: '同意', qrValue: `M${pollNumberStr}-01` }, { text: '不同意', qrValue: `M${pollNumberStr}-02` } ]
            };
            state.polls.push(pollData);
            renderPolls();
            debouncedSaveState();
        }
        
        function renderPolls() {
            pollsListContainer.innerHTML = '';
            state.polls.forEach((poll) => {
                const pollElement = document.createElement('div');
                pollElement.className = 'p-4 border border-gray-300 rounded-lg bg-gray-50';
                pollElement.dataset.id = poll.id;

                const optionsHTML = poll.options.map((opt, optIndex) => `
                    <div class="option-input-group mt-2">
                        <input type="text" value="${escapeHTML(opt.text)}" class="option-text-input border-gray-300 rounded-md shadow-sm" placeholder="選項文字" data-option-index="${optIndex}">
                        <input type="text" value="${escapeHTML(opt.qrValue)}" class="option-qr-input border-gray-300 rounded-md shadow-sm" placeholder="自訂QR Code碼" data-option-index="${optIndex}">
                        <button class="remove-option-btn bg-red-100 text-red-700 px-2 py-1 rounded hover:bg-red-200 text-sm" data-option-index="${optIndex}">移除</button>
                    </div>
                `).join('');

                pollElement.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <input type="text" value="${escapeHTML(poll.sectionTitle)}" class="poll-section-title-input text-lg font-semibold text-gray-800 bg-transparent w-auto focus:bg-white focus:outline-none rounded px-2 py-1 border border-transparent focus:border-gray-300">
                        <button class="remove-poll-btn bg-red-500 text-white font-bold py-1 px-3 rounded-md hover:bg-red-600 text-sm">刪除投票</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">主旨</label>
                            <input type="text" value="${escapeHTML(poll.title)}" class="poll-title-input mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">提案人</label>
                            <input type="text" value="${escapeHTML(poll.proposer)}" class="poll-proposer-input mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                    </div>
                     <div class="mt-4">
                         <label class="block text-sm font-medium text-gray-700">說明</label>
                         <textarea class="poll-description-input mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" rows="2">${escapeHTML(poll.description)}</textarea>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700">投票項目</label>
                        <div class="options-container">${optionsHTML}</div>
                        <button class="add-option-btn mt-2 text-sm text-blue-600 hover:text-blue-800">+ 新增選項</button>
                    </div>
                `;
                pollsListContainer.appendChild(pollElement);
            });
        }
        
        function handlePollsListEvent(e) {
            const target = e.target;
            const pollElement = target.closest('[data-id]');
            if (!pollElement) return;
            const pollId = pollElement.dataset.id;
            const poll = state.polls.find(p => p.id === pollId);
            if (!poll) return;
            
            // --- Handle input changes ---
            if (['change', 'input'].includes(e.type) && target.matches('input, textarea')) {
                if (target.classList.contains('poll-section-title-input')) poll.sectionTitle = target.value;
                else if (target.classList.contains('poll-title-input')) poll.title = target.value;
                else if (target.classList.contains('poll-proposer-input')) poll.proposer = target.value;
                else if (target.classList.contains('poll-description-input')) poll.description = target.value;
                else if (target.matches('.option-text-input, .option-qr-input')) {
                    const optionIndex = parseInt(target.dataset.optionIndex, 10);
                    const property = target.classList.contains('option-text-input') ? 'text' : 'qrValue';
                    poll.options[optionIndex][property] = target.value;
                }
                debouncedSaveState();
            }

            // --- Handle button clicks ---
            if (e.type === 'click') {
                if (target.classList.contains('remove-poll-btn')) {
                    state.polls = state.polls.filter(p => p.id !== pollId);
                    renderPolls(); // Re-render to remove the element and re-attach listeners
                    debouncedSaveState();
                } else if (target.classList.contains('add-option-btn')) {
                    const pollNumber = parseInt(poll.id.split('-')[1], 10);
                    const pollNumberStr = String(pollNumber).padStart(2, '0');
                    const newIndex = poll.options.length + 1;
                    const newOptionNumberStr = String(newIndex).padStart(2, '0');
                    poll.options.push({ text: '', qrValue: `M${pollNumberStr}-${newOptionNumberStr}` });
                    renderPolls();
                    debouncedSaveState();
                } else if (target.classList.contains('remove-option-btn')) {
                    const optionIndex = parseInt(target.dataset.optionIndex, 10);
                    poll.options.splice(optionIndex, 1);
                    renderPolls();
                    debouncedSaveState();
                }
            }
        }

        function renderResidents() {
            residentsListTbody.innerHTML = '';
             if (state.residents.length === 0) {
                 residentsListTbody.innerHTML = `<tr><td colspan="9" class="p-4 text-center text-gray-500">請從CSV檔案匯入住戶資料。</td></tr>`;
             } else {
                 state.residents.forEach((res, index) => {
                     const tr = document.createElement('tr');
                     tr.className = 'hover:bg-gray-50';
                     const hasVoted = state.votes[res.id] && Object.keys(state.votes[res.id]).length > 0;
                     tr.innerHTML = `
                         <td class="p-3"><input type="checkbox" class="resident-checkbox h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500" data-resident-id="${res.id}"></td>
                         <td class="p-3 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                         <td class="p-3 whitespace-nowrap text-sm text-gray-500">${escapeHTML(res.qrcodeValue)}</td>
                         <td class="p-3 whitespace-nowrap text-sm text-gray-500">${escapeHTML(res.unit)}</td>
                         <td class="p-3 whitespace-nowrap text-sm text-gray-500">${escapeHTML(res.name)}</td>
                         <td class="p-3 whitespace-nowrap text-sm text-gray-500">${escapeHTML(res.address)}</td>
                         <td class="p-3 whitespace-nowrap text-sm text-gray-500">${escapeHTML(res.area)}</td>
                         <td class="p-3 whitespace-nowrap text-sm text-gray-500">${escapeHTML(res.ownership)}</td>
                         <td class="p-3 whitespace-nowrap text-sm"><button data-resident-id="${res.id}" class="manual-vote-btn ${hasVoted ? 'bg-green-600' : 'bg-yellow-500'} text-white text-xs font-bold py-1 px-2 rounded hover:opacity-80">${hasVoted ? '編輯投票' : '尚未投票'}</button></td>
                     `;
                     residentsListTbody.appendChild(tr);
                 });
             }
             updateResidentCounts();
             selectAllResidentsCheckbox.checked = false;
        }

        function updateResidentCounts() {
            const total = state.residents.length;
            const selected = document.querySelectorAll('.resident-checkbox:checked').length;
            totalResidentsCountSpan.textContent = total;
            selectedResidentsCountSpan.textContent = selected;
            selectAllResidentsCheckbox.disabled = total === 0;
        }
        
        function handleDownloadSampleCsv() {
            const csvContent = 'data:text/csv;charset=utf-8,\uFEFF'
                + 'qrcodeValue,unit,name,address,area,ownership\n'
                + '"A001","A-01","王大明","幸福路一段1號1樓","25.5","0.05"\n'
                + '"A002","A-02","陳小美","幸福路一段1號2樓","30.1","0.07"\n';
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "sample_residents.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function generateAndPrintSlips() {
            const printArea = document.getElementById('print-area');
            if (!printArea) return;
            
            const selectedResidentIds = Array.from(document.querySelectorAll('.resident-checkbox:checked')).map(cb => cb.dataset.residentId);
            if (selectedResidentIds.length === 0) {
                return showAlert('無法產生', '請至少選擇一位住戶來列印投票單。');
            }
            if (state.polls.length === 0) {
                return showAlert('無法產生', '請先建立至少一個投票項目。');
            }

            loader.classList.remove('hidden');

            setTimeout(() => {
                try {
                    const selectedResidents = state.residents.filter(res => selectedResidentIds.includes(res.id));
                    const eventDate = new Date(state.settings.eventDate);
                    const formattedDate = `投票日期 : ${eventDate.getFullYear()}年${eventDate.getMonth() + 1}月${eventDate.getDate()}日`;
                    
                    const allPagesHTML = selectedResidents.map((resident) => {
                        const residentPrefix = resident.qrcodeValue || resident.unit;
                        if (!residentPrefix) {
                            console.error(`住戶 ${resident.name} (${resident.unit}) 沒有 'qrcodeValue' 或 '戶號'，無法為其產生 QR Code。`);
                            return ''; // Skip this resident if they have no identifier
                        }
                        
                        const residentContentHTML = state.polls.map((poll) => {
                            const optionsHTML = poll.options.map((option, optIndex) => {
                                const finalQrCodeValue = `${residentPrefix}${option.qrValue}`;
                                const escapedQrData = escapeHTML(finalQrCodeValue);
                                return `
                                    <div class="option-item">
                                        <div class="option-qr-code" id="qr-${resident.id}-${poll.id}-${optIndex}" data-qr-content="${escapedQrData}"></div>
                                        <span class="option-text">${escapeHTML(option.text)} (　　)</span>
                                    </div>`;
                            }).join('');

                            return `
                                <div class="poll-container">
                                    <h3 class="poll-title">${escapeHTML(poll.sectionTitle)}</h3>
                                    <div class="poll-details">
                                        <strong>主旨：</strong>${escapeHTML(poll.title)}<br>
                                        <strong>說明：</strong>${escapeHTML(poll.description).replace(/\n/g, '<br>')}<br>
                                        <strong>提案人：</strong>${escapeHTML(poll.proposer)}
                                    </div>
                                    <div class="options-grid">${optionsHTML}</div>
                                </div>
                            `;
                        }).join('');

                        return `
                            <div class="resident-print-container">
                                <table class="print-table">
                                    <thead>
                                        <tr>
                                            <td>
                                                <div class="print-header-wrapper">
                                                    <div class="print-header">
                                                        <h1>${escapeHTML(state.settings.communityName)}</h1>
                                                        <h2>${escapeHTML(state.settings.eventName)} 投票單</h2>
                                                        <p>${escapeHTML(formattedDate)}</p>
                                                    </div>
                                                    <div class="resident-unit-header">${escapeHTML(resident.unit)}</div>
                                                </div>
                                            </td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>
                                                ${residentContentHTML}
                                            </td>
                                        </tr>
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td>
                                                <div class="print-footer"></div>
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        `;
                    }).join('');
                    
                    printArea.innerHTML = allPagesHTML;
                    
                    const qrPromises = Array.from(printArea.querySelectorAll('.option-qr-code')).map(el => 
                        new Promise((resolve) => {
                            setTimeout(() => { // Yield to main thread for each QR code
                                try {
                                    const content = el.dataset.qrContent;
                                    if (content && content.trim() !== '') {
                                        new QRCode(el, { text: content, width: 80, height: 80, correctLevel: QRCode.CorrectLevel.M });
                                    } else {
                                        el.innerHTML = '<span class="text-red-500 text-xs">無QR碼</span>';
                                    }
                                } catch (e) {
                                    console.error("QR Code generation failed:", el.dataset.qrContent, e);
                                    el.innerHTML = '<span class="text-red-500 text-xs">錯誤</span>';
                                }
                                resolve();
                            }, 0);
                        })
                    );
                    
                    Promise.all(qrPromises).then(() => {
                        document.body.classList.add('printing');
                        window.print();
                    });

                } catch (error) {
                    console.error("Error generating print content:", error);
                    showAlert("產生錯誤", "產生投票單時發生錯誤，請檢查主控台(F12)的錯誤訊息。");
                    loader.classList.add('hidden');
                } finally {
                    const afterPrintHandler = () => {
                        document.body.classList.remove('printing');
                        loader.classList.add('hidden');
                        printArea.innerHTML = '';
                        window.removeEventListener('afterprint', afterPrintHandler);
                    };
                    window.addEventListener('afterprint', afterPrintHandler, { once: true });
                }
            }, 100);
        }

        // --- Tabs & Panels ---
        function switchTab(targetTab) {
            stopVoteScanner(); // Stop scanner when switching tabs
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-tab="${targetTab}"]`).classList.add('active');
            
            [settingsPanel, statusPanel, scannerVotingPanel].forEach(panel => {
                if (panel.id === targetTab) {
                    panel.classList.remove('hidden');
                } else {
                    panel.classList.add('hidden');
                }
            });

            if (targetTab === 'status-panel') renderVotingStatus();
            if (targetTab === 'scanner-voting-panel') {
                setTimeout(() => scanGunVoteInput.focus(), 100);
            }
        }

        function renderVotingStatus() {
            statusPanel.innerHTML = ''; // Clear previous content

            const totalResidents = state.residents.length;
            const votedResidentsCount = Object.keys(state.votes).filter(residentId => 
                state.votes[residentId] && Object.keys(state.votes[residentId]).length > 0
            ).length;
            const participation = totalResidents > 0 ? (votedResidentsCount / totalResidents * 100).toFixed(1) : 0;

            let summaryHTML = `
                <section class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h2 class="section-header">總覽</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div>
                            <p class="text-3xl font-bold text-blue-600">${totalResidents}</p>
                            <p class="text-sm text-gray-500">總戶數</p>
                        </div>
                        <div>
                            <p class="text-3xl font-bold text-green-600">${votedResidentsCount}</p>
                            <p class="text-sm text-gray-500">已投票戶數</p>
                        </div>
                        <div>
                            <p class="text-3xl font-bold text-red-600">${totalResidents - votedResidentsCount}</p>
                            <p class="text-sm text-gray-500">未投票戶數</p>
                        </div>
                        <div>
                            <p class="text-3xl font-bold text-purple-600">${participation}%</p>
                            <p class="text-sm text-gray-500">投票率</p>
                        </div>
                    </div>
                </section>
            `;
            statusPanel.innerHTML += summaryHTML;

            state.polls.forEach(poll => {
                const pollResults = {};
                poll.options.forEach(opt => pollResults[opt.qrValue] = 0);
                
                let totalVotesForPoll = 0;
                Object.values(state.votes).forEach(residentVotes => {
                    if (residentVotes[poll.id]) {
                        const voteValue = residentVotes[poll.id];
                        if (pollResults.hasOwnProperty(voteValue)) {
                            pollResults[voteValue]++;
                        }
                        totalVotesForPoll++;
                    }
                });

                let pollHTML = `
                    <section class="bg-white p-6 rounded-lg shadow-md mb-8">
                        <h3 class="text-xl font-bold text-gray-800">${escapeHTML(poll.sectionTitle)}: ${escapeHTML(poll.title)}</h3>
                        <p class="text-sm text-gray-500 mb-4">總投票數: ${totalVotesForPoll}</p>
                        <div class="space-y-3">
                `;

                poll.options.forEach(option => {
                    const votes = pollResults[option.qrValue];
                    const percentage = totalVotesForPoll > 0 ? (votes / totalVotesForPoll * 100).toFixed(1) : 0;
                    pollHTML += `
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-base font-medium text-gray-700">${escapeHTML(option.text)}</span>
                                <span class="text-sm font-medium text-gray-700">${votes} 票 (${percentage}%)</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-4">
                                <div class="bg-red-500 h-4 rounded-full" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                });

                pollHTML += '</div></section>';
                statusPanel.innerHTML += pollHTML;
            });
        }

        // --- Manual & Scanned Voting ---
        function showManualVoteModal(residentId) {
            const resident = state.residents.find(r => r.id === residentId);
            if (!resident) return;

            const residentVotes = state.votes[residentId] || {};
            
            const formContent = document.createElement('form');
            formContent.id = 'manual-vote-form';
            let formHTML = `<p class="mb-4">正在為 <strong>${escapeHTML(resident.unit)} ${escapeHTML(resident.name)}</strong> 進行手動投票。</p>`;

            state.polls.forEach(poll => {
                formHTML += `<fieldset class="mb-4 p-3 border rounded">
                    <legend class="font-semibold px-2">${escapeHTML(poll.sectionTitle)}: ${escapeHTML(poll.title)}</legend>
                    <div class="space-y-2 mt-2">
                `;
                const currentVote = residentVotes[poll.id];
                poll.options.forEach(option => {
                    const isChecked = currentVote === option.qrValue;
                    formHTML += `
                        <label class="flex items-center p-2 rounded hover:bg-gray-100 cursor-pointer">
                            <input type="radio" name="${poll.id}" value="${option.qrValue}" class="h-4 w-4 text-red-600 border-gray-300 focus:ring-red-500" ${isChecked ? 'checked' : ''}>
                            <span class="ml-3 text-gray-700">${escapeHTML(option.text)}</span>
                        </label>
                    `;
                });
                formHTML += `</div></fieldset>`;
            });
            formContent.innerHTML = formHTML;

            showModal('手動投票', formContent, [
                { text: '取消', value: 'cancel', class: 'bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-400' },
                { text: '儲存投票', value: 'submit', class: 'bg-red-600 text-white font-bold py-2 px-4 rounded-md hover:bg-red-700' }
            ]).then(result => {
                if (result === 'submit') {
                    const formData = new FormData(document.getElementById('manual-vote-form'));
                    if (!state.votes[residentId]) {
                        state.votes[residentId] = {};
                    }
                    // Clear previous votes for this resident for all polls before setting new ones
                    // to handle cases where a radio is unchecked
                    state.polls.forEach(p => delete state.votes[residentId][p.id]);

                    for (let [pollId, qrValue] of formData.entries()) {
                        state.votes[residentId][pollId] = qrValue;
                    }
                    debouncedSaveState();
                    renderResidents(); // To update button state
                    showAlert('成功', '投票已成功儲存！');
                    hideModal();
                }
            });
        }
        
        // --- Scanner Voting Logic ---
        function startVoteScanner() {
            if (!html5QrCode) html5QrCode = new Html5Qrcode("vote-reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1 };
            
            voteReaderPlaceholder.classList.add('hidden');
            html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => handleVoteScan(decodedText, '攝影機'))
                .then(() => {
                    startVoteScanBtn.disabled = true;
                    stopVoteScanBtn.disabled = false;
                })
                .catch(err => {
                    scannerVoteStatus.textContent = '無法啟動攝影機。請確認權限。';
                    scannerVoteStatus.className = 'mt-4 text-center font-semibold p-3 rounded-md bg-red-100 text-red-700';
                    voteReaderPlaceholder.classList.remove('hidden');
                });
        }

        function stopVoteScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop()
                    .then(() => {
                        startVoteScanBtn.disabled = false;
                        stopVoteScanBtn.disabled = true;
                        voteReaderPlaceholder.classList.remove('hidden');
                        scannerVoteStatus.innerHTML = '&nbsp;';
                        scannerVoteStatus.className = 'mt-4 text-center font-semibold p-3 rounded-md';
                    })
                    .catch(err => console.log("QR vote scanner stop failed.", err));
            }
        }
        
        let lastVoteScanTime = 0, lastScannedVoteCode = null;
        function handleVoteScan(decodedText, method) {
            const now = Date.now();
            if (now - lastVoteScanTime < 3000 && lastScannedVoteCode === decodedText) return;
            lastVoteScanTime = now;
            lastScannedVoteCode = decodedText;

            const delimiter = 'M';
            const delimiterIndex = decodedText.indexOf(delimiter);

            if (delimiterIndex === -1 || delimiterIndex === 0) {
                scannerVoteStatus.textContent = '無效的投票 QR Code 格式。';
                scannerVoteStatus.className = 'mt-4 text-center font-semibold p-3 rounded-md bg-red-100 text-red-700';
                speak("無效的QR code");
                return;
            }
            
            const residentIdentifier = decodedText.substring(0, delimiterIndex);
            const optionQrValue = decodedText.substring(delimiterIndex);

            // Find resident by qrcodeValue (from CSV) first, then by unit number
            let resident = state.residents.find(r => r.qrcodeValue && r.qrcodeValue === residentIdentifier);
            if (!resident) {
                resident = state.residents.find(r => r.unit && r.unit === residentIdentifier);
            }

            if (!resident) {
                scannerVoteStatus.textContent = `無效的住戶識別碼: ${escapeHTML(residentIdentifier)}`;
                scannerVoteStatus.className = 'mt-4 text-center font-semibold p-3 rounded-md bg-red-100 text-red-700';
                speak("無效的住戶");
                return;
            }

            let targetPoll = null, targetOption = null;
            for (const poll of state.polls) {
                const foundOption = poll.options.find(opt => opt.qrValue === optionQrValue);
                if (foundOption) {
                    targetPoll = poll;
                    targetOption = foundOption;
                    break;
                }
            }

            if (!targetPoll || !targetOption) {
                scannerVoteStatus.textContent = `無效的投票選項: ${optionQrValue}`;
                scannerVoteStatus.className = 'mt-4 text-center font-semibold p-3 rounded-md bg-red-100 text-red-700';
                speak("無效的選項");
                return;
            }
            
            // Record vote
            if (!state.votes[resident.id]) state.votes[resident.id] = {};
            
            const isRepeatVote = state.votes[resident.id][targetPoll.id] === targetOption.qrValue;

            state.votes[resident.id][targetPoll.id] = targetOption.qrValue;
            saveState(); // Immediate save for responsiveness

            const feedbackMsg = `${resident.unit} ${resident.name} 投給 "${targetPoll.title}" - "${targetOption.text}"`;
            if(isRepeatVote) {
                 scannerVoteStatus.textContent = `重複投票: ${feedbackMsg}`;
                 scannerVoteStatus.className = 'mt-4 text-center font-semibold p-3 rounded-md bg-yellow-100 text-yellow-800';
                 speak("重複投票");
            } else {
                 scannerVoteStatus.textContent = `投票成功: ${feedbackMsg}`;
                 scannerVoteStatus.className = 'mt-4 text-center font-semibold p-3 rounded-md bg-green-100 text-green-800';
                 speak("投票成功");
            }
            
            // Update UI
            updateRecentVotesList(resident, targetPoll, targetOption, method);
            renderResidents(); // To update the button in the residents list
        }

        function updateRecentVotesList(resident, poll, option, method) {
             if (scannerRecentVotesList.children.length > 0 && scannerRecentVotesList.children[0].textContent.includes('顯示於此')) {
                 scannerRecentVotesList.innerHTML = '';
             }
             const li = document.createElement('li');
             li.className = 'p-2 bg-gray-50 rounded-md';
             const time = new Date().toLocaleTimeString('zh-TW');
             li.innerHTML = `<div><span class="font-bold">${resident.unit} ${resident.name}</span> - ${time}</div>
                             <div class="text-sm text-gray-600 pl-2">投給 "${poll.title}" - "${option.text}" (${method})</div>`;
             scannerRecentVotesList.insertBefore(li, scannerRecentVotesList.firstChild);
             if (scannerRecentVotesList.children.length > 20) {
                 scannerRecentVotesList.removeChild(scannerRecentVotesList.lastChild);
             }
        }

        // --- Event Listeners ---
        tabsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('tab-button')) {
                switchTab(e.target.dataset.tab);
            }
        });

        document.querySelectorAll('#community-name, #event-name, #event-date').forEach(input => input.addEventListener('change', debouncedSaveState));
        addPollBtn.addEventListener('click', () => createPoll());
        pollsListContainer.addEventListener('change', handlePollsListEvent);
        pollsListContainer.addEventListener('click', handlePollsListEvent);
        pollsListContainer.addEventListener('input', handlePollsListEvent);

        importCsvBtn.addEventListener('click', () => importCsvInput.click());
        importCsvInput.addEventListener('change', handleCsvImport);
        clearResidentsBtn.addEventListener('click', clearResidentsList);
        downloadSampleCsvBtn.addEventListener('click', (e) => { e.preventDefault(); handleDownloadSampleCsv(); });

        selectAllResidentsCheckbox.addEventListener('change', (e) => {
            document.querySelectorAll('.resident-checkbox').forEach(cb => cb.checked = e.target.checked);
            updateResidentCounts();
        });
        residentsListTbody.addEventListener('change', (e) => {
            if (e.target.classList.contains('resident-checkbox')) updateResidentCounts();
        });
        residentsListTbody.addEventListener('click', (e) => {
            if (e.target.classList.contains('manual-vote-btn')) {
                showManualVoteModal(e.target.dataset.residentId);
            }
        });

        generatePrintBtn.addEventListener('click', generateAndPrintSlips);
        
        // Scanner Voting listeners
        startVoteScanBtn.addEventListener('click', startVoteScanner);
        stopVoteScanBtn.addEventListener('click', stopVoteScanner);
        scanGunVoteForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const code = scanGunVoteInput.value.trim();
            if (code) {
                handleVoteScan(code, '掃碼槍');
                scanGunVoteInput.value = '';
            }
        });

        // --- Initial Load ---
        loadState();
    });
    </script>
</body>
</html>
