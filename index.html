<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code 投票單產生器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        /* --- General UI Styles --- */
        .section-header {
            border-bottom: 2px solid #ef4444; /* red-500 */
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: #b91c1c; /* red-700 */
        }
        .option-input-group {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 0.5rem;
            align-items: center;
        }

        /* --- Print Specific Styles --- */
        @media print {
            @page {
                size: A4;
                margin: 1cm;
            }

            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                background-color: #ffffff !important;
                margin: 0;
            }

            /* Hide the main application UI when printing */
            #app, #loader {
                display: none !important;
            }

            .resident-print-container {
                page-break-after: always;
                position: relative;
            }

            .poll-container {
                page-break-inside: avoid; /* Prevent polls from splitting across pages */
                margin-top: 1.5rem;
                border: 1px solid #666;
                padding: 0.75rem;
                border-radius: 5px;
            }
            
            .print-header {
                text-align: center;
                margin-bottom: 1rem;
            }
            
            .print-header h1 { font-size: 18pt; font-weight: bold; margin: 0; }
            .print-header h2 { font-size: 16pt; font-weight: bold; margin: 0; }
            .print-header p { text-align: right; margin: 0.5rem 0 0 0; }

            .resident-unit-header {
                position: absolute;
                top: 0;
                right: 0;
                font-size: 14pt;
                font-weight: bold;
            }
            
            .poll-title {
                font-size: 14pt;
                font-weight: bold;
                margin-bottom: 0.75rem;
            }
            
            .poll-details {
                text-align: left;
                font-size: 11pt;
                margin-bottom: 1rem;
                line-height: 1.6;
            }

            .options-grid {
                display: grid;
                grid-template-columns: repeat(5, 1fr);
                gap: 1rem;
            }

            .option-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                text-align: center;
                page-break-inside: avoid;
            }
            
            .option-qr-code {
                width: 80px;
                height: 80px;
                margin-bottom: 0.5rem;
            }

            .option-text {
                font-size: 12pt;
            }
            
            .blank-page {
                page-break-after: always;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Main Application UI (will be hidden on print) -->
    <div id="app" class="max-w-7xl mx-auto p-4 md:p-8 space-y-8">

        <!-- 1. Settings Section -->
        <section class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="section-header">基本設定</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="community-name" class="block text-sm font-medium text-gray-700">社區名稱</label>
                    <input type="text" id="community-name" value="西北社區" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="event-name" class="block text-sm font-medium text-gray-700">會議活動名稱</label>
                    <input type="text" id="event-name" value="113年度區分所有權人會議" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="event-date" class="block text-sm font-medium text-gray-700">投票日期</label>
                    <input type="date" id="event-date" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
            </div>
        </section>

        <!-- 2. Polls Management Section -->
        <section class="bg-white p-6 rounded-lg shadow-md">
            <div class="flex justify-between items-center">
                <h2 class="section-header">投票議題管理</h2>
                <button id="add-poll-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">新增投票</button>
            </div>
            <div id="polls-list" class="mt-4 space-y-4">
                <!-- Polls will be dynamically inserted here -->
            </div>
        </section>
        
        <!-- 3. Residents List Section -->
        <section class="bg-white p-6 rounded-lg shadow-md">
             <div class="flex justify-between items-center">
                <h2 class="section-header">匯入住戶列表</h2>
                <div class="flex items-center gap-2">
                    <input type="file" id="import-csv-input" class="hidden" accept=".csv">
                    <button id="import-csv-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">從CSV匯入</button>
                    <button id="clear-residents-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-600">清空列表</button>
                </div>
            </div>
             <p class="text-sm text-gray-600 mt-2">
                請從「西北社區QR Code報到系統」的住戶管理頁面，點擊「匯出CSV」按鈕，然後將下載的檔案從這裡匯入。
            </p>
            <div class="mt-4 overflow-x-auto max-h-96">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">
                                <input type="checkbox" id="select-all-residents" class="h-4 w-4 text-red-600 border-gray-300 rounded">
                            </th>
                            <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">序號</th>
                            <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">QR Code</th>
                            <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">戶號</th>
                            <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">姓名</th>
                            <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">地址</th>
                            <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">坪數</th>
                            <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">區分權比例</th>
                        </tr>
                    </thead>
                    <tbody id="residents-list" class="bg-white divide-y divide-gray-200">
                        <!-- Residents will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- 4. Action Button -->
        <section class="text-center">
            <button id="generate-print-btn" class="bg-red-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-red-700 text-xl transition-transform transform hover:scale-105">
                列印投票單
            </button>
        </section>

    </div>
    
    <!-- Loading Spinner -->
    <div id="loader" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 z-50 flex items-center justify-center">
        <div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-white"></div>
        <span class="ml-4 text-white text-xl">正在產生投票單...</span>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const communityNameInput = document.getElementById('community-name');
        const eventNameInput = document.getElementById('event-name');
        const eventDateInput = document.getElementById('event-date');
        
        const addPollBtn = document.getElementById('add-poll-btn');
        const pollsListContainer = document.getElementById('polls-list');
        
        const importCsvInput = document.getElementById('import-csv-input');
        const importCsvBtn = document.getElementById('import-csv-btn');
        const clearResidentsBtn = document.getElementById('clear-residents-btn');
        const residentsListTbody = document.getElementById('residents-list');
        const selectAllResidentsCheckbox = document.getElementById('select-all-residents');

        const generatePrintBtn = document.getElementById('generate-print-btn');
        const loader = document.getElementById('loader');
        
        // --- Data State ---
        let polls = [];
        let residents = [];
        let pollIdCounter = 0;

        // --- Initial Setup ---
        eventDateInput.valueAsDate = new Date(); // Set today's date
        addInitialData();

        // --- Event Listeners ---
        addPollBtn.addEventListener('click', () => createPoll());
        importCsvBtn.addEventListener('click', () => importCsvInput.click());
        importCsvInput.addEventListener('change', handleCsvImport);
        clearResidentsBtn.addEventListener('click', clearResidentsList);
        selectAllResidentsCheckbox.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            document.querySelectorAll('.resident-checkbox').forEach(cb => cb.checked = isChecked);
        });
        generatePrintBtn.addEventListener('click', generateAndPrintSlips);


        // --- Utility Functions ---
        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }

        // --- Core Functions ---

        function addInitialData() {
            // Create initial poll
            createPoll({
                sectionTitle: '議題 #1',
                title: '管理費調整案',
                proposer: '管理委員會',
                description: '為提升社區服務品質，擬調整管理費...',
                options: [
                    { text: '同意', qrValue: 'M01-01' },
                    { text: '不同意', qrValue: 'M01-02' },
                    { text: '廢票', qrValue: 'M01-03' }
                ]
            });
            renderResidents(); // Render the initial empty state for residents
        }

        function handleCsvImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                try {
                    const parsedResidents = parseCSV(text);
                    if (parsedResidents.length === 0) {
                         alert('CSV檔案中沒有可辨識的住戶資料，請確認檔案格式是否正確。');
                         return;
                    }
                    residents = parsedResidents; // Replace existing residents
                    renderResidents();
                    alert(`成功匯入 ${residents.length} 筆住戶資料！`);
                } catch (error) {
                    console.error("CSV Parsing Error:", error);
                    alert(`匯入失敗：${error.message}`);
                }
            };
            reader.onerror = () => {
                alert('讀取檔案時發生錯誤。');
            };
            reader.readAsText(file, "UTF-8");
            
            event.target.value = ''; // Reset input for re-uploading the same file
        }

        function parseCSV(text) {
            const rows = text.split('\n').filter(row => row.trim() !== '');
            if (rows.length < 2) {
                throw new Error("CSV檔案至少需要一個標頭行和一行資料。");
            }
            
            const headerRow = rows[0].trim().startsWith('\uFEFF') ? rows[0].trim().substring(1) : rows[0].trim();
            const headers = headerRow.split(',').map(h => h.replace(/"/g, '').trim());

            const headerMap = {
                qrcodeValue: ['qrcodeValue', 'QR Code', 'QR Code碼'],
                unit: ['unit', '戶號'],
                name: ['name', '姓名'],
                address: ['address', '住址', '地址'],
                area: ['area', '坪數'],
                ownership: ['ownership', '區分權(%)', '區分權比例']
            };

            const findIndex = (possibleNames) => {
                for (const name of possibleNames) {
                    const index = headers.indexOf(name);
                    if (index !== -1) return index;
                }
                return -1;
            };

            const indices = {
                qrcodeValue: findIndex(headerMap.qrcodeValue),
                unit: findIndex(headerMap.unit),
                name: findIndex(headerMap.name),
                address: findIndex(headerMap.address),
                area: findIndex(headerMap.area),
                ownership: findIndex(headerMap.ownership)
            };

            if (indices.unit === -1 || indices.name === -1) {
                throw new Error(`CSV檔案的標頭 (header) 必須包含 "unit" (或 "戶號") 和 "name" (或 "姓名")。`);
            }
            
            const importedResidents = [];
            for (let i = 1; i < rows.length; i++) {
                const values = rows[i].trim().split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.replace(/"/g, '').trim());
                
                const resident = {
                    id: `resident-${i}`,
                    unit: values[indices.unit] || '',
                    name: values[indices.name] || '',
                    qrcodeValue: indices.qrcodeValue !== -1 ? (values[indices.qrcodeValue] || '') : '',
                    address: indices.address !== -1 ? (values[indices.address] || '') : '',
                    area: indices.area !== -1 ? (values[indices.area] || '') : '',
                    ownership: indices.ownership !== -1 ? (values[indices.ownership] || '') : ''
                };

                if (resident.unit && resident.name) {
                    importedResidents.push(resident);
                }
            }
            return importedResidents;
        }


        function clearResidentsList() {
            if (residents.length > 0 && confirm('您確定要清空目前的住戶列表嗎？')) {
                residents = [];
                renderResidents();
            }
        }
        
        function createPoll(initialData = {}) {
            pollIdCounter++;
            const pollId = `poll-${pollIdCounter}`;
            const pollNumberStr = String(pollIdCounter).padStart(2, '0');
            
            const pollData = {
                id: pollId,
                sectionTitle: initialData.sectionTitle || `議題 #${pollIdCounter}`,
                title: initialData.title || `新投票 ${pollIdCounter}`,
                proposer: initialData.proposer || '',
                description: initialData.description || '',
                options: initialData.options || [
                    { text: '同意', qrValue: `M${pollNumberStr}-01` },
                    { text: '不同意', qrValue: `M${pollNumberStr}-02` }
                ]
            };
            polls.push(pollData);
            renderPolls();
        }
        
        function renderPolls() {
            pollsListContainer.innerHTML = '';
            polls.forEach((poll) => {
                const pollElement = document.createElement('div');
                pollElement.className = 'p-4 border border-gray-300 rounded-lg';
                pollElement.dataset.id = poll.id;

                let optionsHTML = '';
                poll.options.forEach((opt, optIndex) => {
                    optionsHTML += `
                        <div class="option-input-group mt-2">
                            <input type="text" value="${escapeHTML(opt.text)}" class="option-text-input border-gray-300 rounded-md shadow-sm" placeholder="選項文字" data-option-index="${optIndex}">
                            <input type="text" value="${escapeHTML(opt.qrValue)}" class="option-qr-input border-gray-300 rounded-md shadow-sm" placeholder="自訂QR Code碼" data-option-index="${optIndex}">
                            <button class="remove-option-btn bg-red-100 text-red-700 px-2 py-1 rounded hover:bg-red-200 text-sm" data-option-index="${optIndex}">移除</button>
                        </div>
                    `;
                });

                pollElement.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <input type="text" value="${escapeHTML(poll.sectionTitle)}" class="poll-section-title-input text-lg font-semibold text-gray-800 bg-transparent w-auto focus:bg-gray-100 focus:outline-none rounded px-2 py-1 border border-transparent focus:border-gray-300">
                        <button class="remove-poll-btn bg-red-500 text-white font-bold py-1 px-3 rounded-md hover:bg-red-600 text-sm">刪除投票</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">主旨</label>
                            <input type="text" value="${escapeHTML(poll.title)}" class="poll-title-input mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">提案人</label>
                            <input type="text" value="${escapeHTML(poll.proposer)}" class="poll-proposer-input mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                    </div>
                     <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700">說明</label>
                        <textarea class="poll-description-input mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" rows="2">${escapeHTML(poll.description)}</textarea>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700">投票項目</label>
                        <div class="options-container">${optionsHTML}</div>
                        <button class="add-option-btn mt-2 text-sm text-blue-600 hover:text-blue-800">+ 新增選項</button>
                    </div>
                `;
                pollsListContainer.appendChild(pollElement);
            });
            addPollEventListeners();
        }

        function addPollEventListeners() {
            document.querySelectorAll('.poll-section-title-input, .poll-title-input, .poll-proposer-input, .poll-description-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const pollId = e.target.closest('[data-id]').dataset.id;
                    const poll = polls.find(p => p.id === pollId);
                    if (!poll) return;

                    if (e.target.classList.contains('poll-section-title-input')) poll.sectionTitle = e.target.value;
                    else if (e.target.classList.contains('poll-title-input')) poll.title = e.target.value;
                    else if (e.target.classList.contains('poll-proposer-input')) poll.proposer = e.target.value;
                    else if (e.target.classList.contains('poll-description-input')) poll.description = e.target.value;
                });
            });

            document.querySelectorAll('.remove-poll-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const pollId = e.target.closest('[data-id]').dataset.id;
                    polls = polls.filter(p => p.id !== pollId);
                    renderPolls();
                });
            });

            document.querySelectorAll('.add-option-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const pollId = e.target.closest('[data-id]').dataset.id;
                    const poll = polls.find(p => p.id === pollId);
                    if (!poll) return;
                    const pollNumber = parseInt(poll.id.split('-')[1], 10);
                    const pollNumberStr = String(pollNumber).padStart(2, '0');
                    const newIndex = poll.options.length + 1;
                    const newOptionNumberStr = String(newIndex).padStart(2, '0');
                    poll.options.push({ text: '', qrValue: `M${pollNumberStr}-${newOptionNumberStr}` });
                    renderPolls();
                });
            });
            
            document.querySelectorAll('.remove-option-btn').forEach(btn => {
                 btn.addEventListener('click', (e) => {
                    const pollId = e.target.closest('[data-id]').dataset.id;
                    const optionIndex = parseInt(e.target.dataset.optionIndex, 10);
                    const poll = polls.find(p => p.id === pollId);
                    if (poll) {
                        poll.options.splice(optionIndex, 1);
                        renderPolls();
                    }
                });
            });

            document.querySelectorAll('.option-text-input, .option-qr-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const pollId = e.target.closest('[data-id]').dataset.id;
                    const optionIndex = parseInt(e.target.dataset.optionIndex, 10);
                    const poll = polls.find(p => p.id === pollId);
                    if (!poll || !poll.options[optionIndex]) return;
                    const property = e.target.classList.contains('option-text-input') ? 'text' : 'qrValue';
                    poll.options[optionIndex][property] = e.target.value;
                });
            });
        }
        
        function renderResidents() {
            residentsListTbody.innerHTML = '';
             if (residents.length === 0) {
                residentsListTbody.innerHTML = `<tr><td colspan="8" class="p-4 text-center text-gray-500">請從CSV檔案匯入住戶資料。</td></tr>`;
            } else {
                residents.forEach((res, index) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="p-3">
                            <input type="checkbox" class="resident-checkbox h-4 w-4 text-red-600 border-gray-300 rounded" data-resident-id="${res.id}">
                        </td>
                        <td class="p-3 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                        <td class="p-3 whitespace-nowrap text-sm text-gray-500">${escapeHTML(res.qrcodeValue)}</td>
                        <td class="p-3 whitespace-nowrap text-sm text-gray-500">${escapeHTML(res.unit)}</td>
                        <td class="p-3 whitespace-nowrap text-sm text-gray-500">${escapeHTML(res.name)}</td>
                        <td class="p-3 whitespace-nowrap text-sm text-gray-500">${escapeHTML(res.address)}</td>
                        <td class="p-3 whitespace-nowrap text-sm text-gray-500">${escapeHTML(res.area)}</td>
                        <td class="p-3 whitespace-nowrap text-sm text-gray-500">${escapeHTML(res.ownership)}</td>
                    `;
                    residentsListTbody.appendChild(tr);
                });
            }
            selectAllResidentsCheckbox.checked = false;
        }

        async function generateAndPrintSlips() {
            const printArea = document.getElementById('print-area');
            if (!printArea) {
                console.error("Print area not found!");
                return;
            }
            
            loader.classList.remove('hidden');

            // Use setTimeout to allow the loader to render before starting heavy work
            setTimeout(() => {
                try {
                    const selectedResidentIds = Array.from(document.querySelectorAll('.resident-checkbox:checked')).map(cb => cb.dataset.residentId);
                    
                    if (selectedResidentIds.length === 0) {
                        alert('請至少選擇一位住戶來列印投票單。');
                        return;
                    }

                    if (polls.length === 0) {
                        alert('請先建立至少一個投票項目。');
                        return;
                    }

                    const selectedResidents = residents.filter(res => selectedResidentIds.includes(res.id));
                    const communityName = communityNameInput.value;
                    const eventName = eventNameInput.value;
                    const eventDate = eventDateInput.value ? new Date(eventDateInput.value) : new Date();
                    const formattedDate = `投票日期 : ${eventDate.getFullYear()}年${eventDate.getMonth() + 1}月${eventDate.getDate()}日`;

                    let allPagesHTML = '';

                    selectedResidents.forEach((resident, residentIdx) => {
                        const residentIndexInFullList = residents.findIndex(r => r.id === resident.id);
                        const residentPrefix = `A${String(residentIndexInFullList + 1).padStart(3, '0')}`;
                        
                        let residentContentHTML = `
                            <div class="print-header">
                                <h1>${escapeHTML(communityName)}</h1>
                                <h2>${escapeHTML(eventName)} 投票單</h2>
                                <p>${escapeHTML(formattedDate)}</p>
                            </div>
                        `;
                        
                        polls.forEach((poll) => {
                            let optionsHTML = '';
                            poll.options.forEach((option, optIndex) => {
                                const finalQrCodeValue = `${residentPrefix}${option.qrValue}`;
                                const qrData = finalQrCodeValue;
                                const escapedQrData = escapeHTML(qrData);

                                optionsHTML += `
                                    <div class="option-item">
                                        <div class="option-qr-code" id="qr-${resident.id}-${poll.id}-${optIndex}" data-qr-content="${escapedQrData}"></div>
                                        <span class="option-text">${escapeHTML(option.text)} (　　)</span>
                                    </div>`;
                            });

                            residentContentHTML += `
                                <div class="poll-container">
                                    <h3 class="poll-title">${escapeHTML(poll.sectionTitle)}</h3>
                                    <div class="poll-details">
                                        <strong>主旨：</strong>${escapeHTML(poll.title)}<br>
                                        <strong>說明：</strong>${escapeHTML(poll.description)}<br>
                                        <strong>提案人：</strong>${escapeHTML(poll.proposer)}
                                    </div>
                                    <div class="options-grid">${optionsHTML}</div>
                                </div>
                            `;
                        });

                        allPagesHTML += `
                            <div class="resident-print-container">
                                <div class="resident-unit-header">${escapeHTML(resident.unit)}</div>
                                ${residentContentHTML}
                            </div>
                        `;

                        // Add a blank page after each resident, except the last one
                        if (residentIdx < selectedResidents.length - 1) {
                            allPagesHTML += '<div class="blank-page"></div>';
                        }
                    });

                    printArea.innerHTML = allPagesHTML;
                    
                    const qrElements = printArea.querySelectorAll('.option-qr-code');
                    qrElements.forEach(el => {
                        try {
                            const content = el.dataset.qrContent;
                            if (content && content.trim() !== '') {
                                new QRCode(el, {
                                    text: content,
                                    width: 80,
                                    height: 80,
                                    correctLevel: QRCode.CorrectLevel.M
                                });
                            } else {
                               el.innerHTML = '<span style="color: red; font-size: 9px;">無 QR 碼內容</span>';
                            }
                        } catch (e) {
                            console.error("無法產生 QR Code:", el.dataset.qrContent, e);
                            el.innerHTML = '<span style="color: red; font-size: 9px;">QR 碼錯誤</span>';
                        }
                    });
                    
                    const iframe = document.createElement('iframe');
                    iframe.style.position = 'absolute';
                    iframe.style.width = '0';
                    iframe.style.height = '0';
                    iframe.style.border = '0';
                    document.body.appendChild(iframe);

                    const pri = iframe.contentWindow;
                    pri.document.open();
                    const styles = Array.from(document.styleSheets)
                        .map(styleSheet => {
                            try {
                                return Array.from(styleSheet.cssRules).map(rule => rule.cssText).join('');
                            } catch (e) {
                                return '';
                            }
                        }).join('\n');

                    pri.document.write('<html><head><style>' + styles + '</style></head><body>');
                    pri.document.write(printArea.innerHTML);
                    pri.document.write('</body></html>');
                    pri.document.close();
                    
                    iframe.onload = () => {
                        pri.focus();
                        pri.print();
                        setTimeout(() => {
                             document.body.removeChild(iframe);
                        }, 500); 
                    };


                } catch (error) {
                    console.error("產生列印內容時發生錯誤:", error);
                    alert("產生投票單時發生錯誤，請檢查主控台(F12)的錯誤訊息。");
                } finally {
                    loader.classList.add('hidden');
                    printArea.innerHTML = '';
                }
            }, 100); // 100ms timeout
        }
    });
    </script>
</body>
</html>
